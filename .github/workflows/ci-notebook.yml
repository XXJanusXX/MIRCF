name: MIRCF Notebook Reproducibility Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  run-notebook:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.12"

      - name: Upgrade pip
        run: |
          python -m pip install --upgrade pip

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install jupyter nbconvert nbformat

      - name: Prepare output directory
        run: |
          mkdir -p outputs

      # -------------------------------
      # Execute notebook (CRITICAL FIX)
      # -------------------------------
      - name: Execute MIRCF notebook
        run: |
          jupyter nbconvert \
            --to notebook \
            --execute notebooks/MIRCF_Section6_Reproduction.ipynb \
            --output executed.ipynb

      # nbconvert writes relative to input notebook directory
      - name: Verify executed notebook exists
        run: |
          test -f notebooks/executed.ipynb || \
            (echo "ERROR: executed notebook missing" && exit 1)

      - name: Verify outputs directory populated
        run: |
          test -d outputs || (echo "ERROR: outputs directory missing" && exit 1)
          test "$(ls -A outputs)" || (echo "ERROR: outputs directory is empty" && exit 1)

      # -------------------------------
      # Checksum generation + validation
      # -------------------------------
      - name: Generate checksums
        run: |
          find outputs -type f -print0 | sort -z | xargs -0 sha256sum > checksums.txt

      - name: Verify checksums
        run: |
          python scripts/verify_checksums.py

      # -------------------------------
      # Upload reproducibility artifacts
      # -------------------------------
      - name: Upload paper figures and executed notebook
        uses: actions/upload-artifact@v4
        with:
          name: mircf-paper-outputs
          path: |
            outputs/**
            notebooks/executed.ipynb
            checksums.txt
